//  Copyright 2010-2020 Robert Bosch Car Multimedia GmbH
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.

"use strict";function createChartAllResultsBars(){var a=document.getElementById("chartAllResultsBars"),b=new Chart(a,{xLableAngle:0,type:"bar",data:{labels:[],datasets:[{type:"line",label:"number resets",backgroundColor:"rgba(0,0,0,0.7)",data:[],borderColor:"rgba(0,0,0,0.8)",yAxisID:"y-axis-2",fill:!1,borderWidth:1,lineTension:.3},{type:"bar",label:"passed",data:[],backgroundColor:$(".test-result-passed").css("background-color"),borderWidth:0,yAxisID:"y-axis-1"},{type:"bar",label:"failed",backgroundColor:$(".test-result-failed").css("background-color"),borderWidth:0,data:[],yAxisID:"y-axis-1"},{type:"bar",label:"unknown",backgroundColor:$(".test-result-unknown").css("background-color"),borderWidth:0,data:[],yAxisID:"y-axis-1"},{type:"bar",label:"aborted",backgroundColor:$(".test-result-aborted").css("background-color"),borderWidth:0,data:[],yAxisID:"y-axis-1"}]},options:{responsive:!0,hoverMode:"label",hoverAnimationDuration:400,title:{display:!0,text:"Test Result per Version"},scales:{xAxes:[{stacked:!0}],yAxes:[{type:"linear",display:!0,position:"left",id:"y-axis-1",stacked:!0,ticks:{max:100}},{type:"linear",display:!0,position:"right",id:"y-axis-2",gridLines:{drawOnChartArea:!1}}]}}});return b}function updateChartAllResultsBars(a){var b;void 0===dPAGE_CHARTS.ChartAllResultsBars&&(dPAGE_CHARTS.ChartAllResultsBars=createChartAllResultsBars()),b=dPAGE_CHARTS.ChartAllResultsBars,b.data.labels=a.labels,b.data.datasets[1].data=a.pt_passed,b.data.datasets[2].data=a.pt_failed,b.data.datasets[3].data=a.pt_unknown,b.data.datasets[4].data=a.pt_aborted,b.data.datasets[0].data=a.num_resets,b.update(500)}function createChartDoughnutResult(){function a(a){var c=a.data.datasets[0].data,d=1-(c[1]+c[2]+c[3])/(c[0]+c[1]+c[2]+c[3]),e=b.getContext("2d"),f=(e.canvas.clientHeight-40)/6,g=String.fromCharCode("0xf088");e.fillStyle=$(".test-result-failed").css("background-color"),d>=.8&&(g=String.fromCharCode("0xf087"),e.fillStyle=$(".test-result-passed").css("background-color")),e.font=f+"px FontAwesome",e.fillText(g,(e.canvas.clientWidth+5)/2-f/2,(e.canvas.clientHeight-40)/2-f/2+40)}var b=document.getElementById("chartSingleResultDonut"),c=new Chart(b,{type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:[$(".test-result-passed").css("background-color"),$(".test-result-failed").css("background-color"),$(".test-result-unknown").css("background-color"),$(".test-result-aborted").css("background-color")]}]},responsive:!0,options:{tooltips:{},animation:{animateRotate:!0,onProgress:function(b){a(c)},onComplete:function(b){a(c)}}}});return c}function updateChartDoughnutResult(a){var b;void 0===dPAGE_CHARTS.ChartDoughnutResult&&(dPAGE_CHARTS.ChartDoughnutResult=createChartDoughnutResult()),b=dPAGE_CHARTS.ChartDoughnutResult,b.data.labels=a.labels,b.data.datasets[0].data=a.data,b.render(),b.update(500);var c=a.data[0]+a.data[1]+a.data[2]+a.data[3],d=a.data[0]/c*100;d=Number(d.toFixed(1)),$("div#panPassedRateText").text(d.toString()+" %"),d>=80?($("#panPassedRate").removeClass("panel-danger").addClass("panel-success"),$("#panPassedRateIcon").removeClass("glyphicon-ban-circle").addClass("glyphicon-ok-circle")):($("#panPassedRate").removeClass("panel-success").addClass("panel-danger"),$("#panPassedRateIcon").removeClass("glyphicon-ok-circle").addClass("glyphicon-ban-circle"),$("#panPassedRate").effect("shake",{distance:1,times:10},2e3,function(){})),$("div#panTestsExecutedText").text(c.toString())}function createChartRadarFailPerComponent(){var a=document.getElementById("chartFailPerComponentSpider"),b=new Chart(a,{type:"radar",data:{labels:[],datasets:[{label:"failed",backgroundColor:$(".test-result-failed").css("background-color").replace("rgb","rgba").replace(")",",0.1)"),borderColor:$(".test-result-failed").css("background-color").replace("rgb","rgba").replace(")",",1.0)"),pointBackgroundColor:$(".test-result-failed").css("background-color"),pointBorderColor:$(".test-result-failed").css("background-color"),data:[]},{label:"unknown",backgroundColor:$(".test-result-unknown").css("background-color").replace("rgb","rgba").replace(")",",0.1)"),borderColor:$(".test-result-unknown").css("background-color").replace("rgb","rgba").replace(")",",1.0)"),pointBackgroundColor:$(".test-result-unknown").css("background-color"),pointBorderColor:$(".test-result-unknown").css("background-color"),data:[]},{label:"aborted",backgroundColor:$(".test-result-aborted").css("background-color").replace("rgb","rgba").replace(")",",0.1)"),borderColor:$(".test-result-aborted").css("background-color").replace("rgb","rgba").replace(")",",1.0)"),pointBackgroundColor:$(".test-result-aborted").css("background-color"),pointBorderColor:$(".test-result-aborted").css("background-color"),data:[]}]}});return b}function updateChartRadarFailPerComponent(a){var b;void 0===dPAGE_CHARTS.chartRadarFailPerComponent&&(dPAGE_CHARTS.chartRadarFailPerComponent=createChartRadarFailPerComponent()),b=dPAGE_CHARTS.chartRadarFailPerComponent,b.data.labels=a.labels,b.data.datasets[0].data=a.num_failed,b.data.datasets[1].data=a.num_unknown,b.data.datasets[2].data=a.num_aborted,b.render(),b.update(500)}function updateExecutionTime(a){var b=a.period%60,c=Number(((a.period-b)/60).toFixed(0));$("div#panExeuctionTimeHoursText").text(c.toString()+" h"),$("div#panExeuctionTimeMinutesText").text(b.toString()+" min")}function updateSummerInterpretation(a){$("#editResultInterpretation").summernote("code","This test result is not yet analyzed ..."),""!=a.data&&$("#editResultInterpretation").summernote("code",b64DecodeUnicode(a.data)),$("#editResultInterpretation").summernote("destroy")}function updateTestResultDataTable(a){if($.fn.dataTable.isDataTable("#tblTestResult")){var b=$("#tblTestResult").DataTable();b.clear(),b.rows.add(a.data),b.draw()}else var b=$("#tblTestResult").DataTable({dom:"lfrtBip",buttons:["copy","excel"],aaData:a.data,aoColumns:[{mDataProp:"symbol",title:"Result"},{mDataProp:"result_main",title:"result_main"},{mDataProp:"result_state",title:"result_state"},{mDataProp:"lastlog",title:"lastlog"},{mDataProp:"filename",title:"filename"},{mDataProp:"testname",title:"Name"},{mDataProp:"component",title:"Component"},{mDataProp:"tcid",title:"tcid"},{mDataProp:"fid",title:"fid"},{mDataProp:"issue",title:"issue"},{mDataProp:"state",title:"state"}],columnDefs:[{visible:!1,targets:[1,2,3,4,10]},{width:"100px",targets:0},{width:"50px",targets:[6,7,8,9,10]}],order:[[4,"asc"]],displayLength:25,drawCallback:function(a){var b=this.api(),c=b.rows({page:"current"}).nodes(),d=null;b.column(4,{page:"current"}).data().each(function(a,b){d!==a&&($(c).eq(b).before('<tr class="group"><td colspan="6">'+a+'<span class="caret pull-right"></span></td></tr>'),d=a)})},createdRow:function(a,b,c){var d="";"result:Passed"==b.result_main.trim()&&(d='<span class="fa-stack test-result-passed symbolTestResult" title="passed"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-check fa-stack-1x" style="color:white"></i></span>'),"result:unknown"==b.result_main.trim()&&("result:complete"==b.result_state.trim()&&(d='<span class="fa-stack test-result-unknown symbolTestResult" title="unknown"><i class="fa fa-square fa-stack-2x"></i><strong class="fa-stack-1x" style="color:white; margin-left: -0.01em;">u</strong></span>'),"result:deactivated"==b.result_state.trim()&&(d='<span class="fa-stack test-result-unknown symbolTestResult" title="unknown - deactivated"><i class="fa fa-square fa-stack-2x"></i><strong class="fa-stack-1x test-result-text">d</strong></span>')),"result:Aborted"==b.result_main.trim()&&(d='<span class="fa-stack test-result-aborted symbolTestResult" title="unknown - aborted"><i class="fa fa-square fa-stack-2x"></i><strong class="fa-stack-1x" style="color:white; margin-left: -0.01em;">a</strong></span>'),"result:Failed"==b.result_main.trim()&&(d='<span class="fa-stack test-result-failed symbolTestResult" title="failed" style="margin-top: 0.1em"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-minus fa-stack-1x" style="color:white"></i></span>'),null!=b.lastlog&&(d+='<button id="btLastLog_'+b.lastlog+'" type="button" class="btn btn-default btn-xs" style="margin-left:8px;margin-top:1px;" onClick="showLastLog(this,'+b.lastlog+')"><i class="fa fa-search" aria-hidden="true"></i></button>');var e="";if("result:Passed"!=b.result_main.trim()){var f="",g="",h="";if(null==b.state)f="?";else{var i=b.state.split("##");f=i[0],g=i[1],h=i[2]}var j="red";switch(f){case"?":j="red";break;case"a":j="orange";break;case"l":j="blue";break;case"n":j="green";break;default:j="red"}var l="select an item";""!=g.trim()&&(l=getTimeToText(g));var m="";""==h.trim()&&(m="hidden");var e=templateToHtml("ddIssueStatus",{TEST_CASE_ID:b.lastlog,USER_NAME:h,DATETIME:l,STATUS_ENVELOPE:m,STATUS_COLOR:j,STATUS_TEXT:f})}var n=b.testname;n=n+'<div id="commentField_'+ +b.lastlog+'" style="margin-top:5px;"></div>',$("td",a).eq(0).html(d+e),$("td",a).eq(1).html(n);var o=b.component.split(":");$("td",a).eq(2).html(o[1])},drawCallback:function(a){var b=this.api().rows({page:"current"}).data();_.each(b,function(a){$("#commentField_"+a.lastlog).html(""),"result:Passed"!=a.result_main.trim()&&getFromDB("/tml/result/base/getTestCaseComments","testcaseid="+a.lastlog,function(b){var c=!1;_.each(b.data,function(b){c=!0;var d=getTimeToText(b.timestamp),e="";""!=b.comment&&(e=b64DecodeUnicode(String.fromCharCode.apply(null,b.comment.data)));var f="hidden";getUser()==b.user&&(f="");var g=templateToHtml("panComment",{TEST_CASE_ID:a.lastlog,COMMENT_ID:b.number,COMMENT_TEXT:e,USER_NAME:getDisplayName(),DATETIME:d,USER_NAME:b.user_name,USER_BADGE_COLOR:getUserColor(b.user_name),USER_BADGE_LETTER:b.user_name.split(" ")[1].charAt(0).toUpperCase(),STATUS_EDITBUTTONS:f});$("#commentField_"+a.lastlog).append(g)}),c&&$('<a style="font-size:0.85em;" href="#" onClick="event.preventDefault(); addComment('+a.lastlog+');" class="pull-right"><i class="fa fa-comment-o"></i> add comment</a>').insertAfter("#commentField_"+a.lastlog)})})},infoCallback:function(a,b,c,d,e,f){return $(".symbolTestResult").tooltip(),"Showing "+b+" to "+c+" of "+d+" entries"},initComplete:function(a,b){$("#loadingTable").hide()}})}function updatePbTestResult(a){console.log(a);var b=a.data[0]+a.data[1]+a.data[2]+a.data[3],c=a.data[0]/b*100,d=a.data[1]/b*100,e=a.data[2]/b*100,f=a.data[3]/b*100;$("#pbTestResultPassed").css("width",c+"%"),$("#pbTestResultPassed").tooltip("hide").attr("data-original-title","Passed: "+a.data[0]+" test cases = "+Number(c.toFixed(1))+"%").tooltip("fixTitle"),$("#pbTestResultFailed").css("width",d+"%"),$("#pbTestResultFailed").tooltip("hide").attr("data-original-title","Failed: "+a.data[1]+" test cases = "+Number(d.toFixed(1))+"%").tooltip("fixTitle"),$("#pbTestResultUnknown").css("width",e+"%"),$("#pbTestResultUnknown").tooltip("hide").attr("data-original-title","unknown: "+a.data[2]+" test cases = "+Number(e.toFixed(1))+"%").tooltip("fixTitle"),$("#pbTestResultAborted").css("width",f+"%"),$("#pbTestResultAborted").tooltip("hide").attr("data-original-title","aborted: "+a.data[3]+" test cases = "+Number(f.toFixed(1))+"%").tooltip("fixTitle")}function doGenericLogin(a){$("#badgeUser").removeClass("hide"),$("#badgeUserText").text(a.displayName.split(" ")[1].charAt(0).toUpperCase()),$("#badgeUserText").attr("data-original-title",a.displayName),$("#badgeUserText").css("background-color",getUserColor(a.displayName)),$("#ddLogin").addClass("disabled"),$("#ddLogout").removeClass("disabled"),$("#ddLogoutTxt").html('<i class="fa fa-sign-out fa-fw"></i> Logout '+a.usr+"</a>")}function doGenericLogout(){$("#badgeUser").addClass("hide"),$("#badgeUserText").text("-"),$("#badgeUserText").attr("data-original-title","-"),$("#ddLogin").removeClass("disabled"),$("#ddLogout").addClass("disabled"),$("#ddLogoutTxt").html('<i class="fa fa-sign-out fa-fw"></i> Logout</a>')}function doSpecificLogin(a){$("#btnEditResultInterpretationEdit").removeClass("hide"),$("#btnEditResultInterpretationSave").removeClass("hide")}function doSpecificLogout(){$("#btnEditResultInterpretationEdit").addClass("hide"),$("#btnEditResultInterpretationSave").addClass("hide")}function loggedIn(){getFromDB("/loggedin","",function(a){console.log(a),1==a.admin&&(doGenericLogin(a),doSpecificLogin(a))})}function isLoggedIn(){return!$("#badgeUser").hasClass("hide")}function getDisplayName(){return $("#badgeUserText").attr("data-original-title")}function getUser(){return $("#ddLogoutTxt").text().split(" ")[2]}function getLogin(a,b,c){var d=a.val(),e=b.val(),f=c.val();getFromDB("/getPubKey","",function(a){var b=new JSEncrypt;b.setPublicKey(a.pubKey);var g=b.encrypt(f);postToDB("/login",{usr:d,dom:e,pwd:g},function(a){console.log(a),"login_success"==a.data?(c.val(""),doGenericLogin({usr:d,displayName:a.displayName}),doSpecificLogin({usr:d,displayName:a.displayName}),$("#txtWrongLogin").addClass("hide"),$("#loginModal").modal("hide")):$("#txtWrongLogin").removeClass("hide").hide().slideDown(500)})})}function setLogout(){getFromDB("/logout","",function(a){console.log(a),"logout_success"==a.data&&(doGenericLogout(),doSpecificLogout())})}function createMetisMenu(){$("#side-menu").metisMenu(),$(window).bind("load resize",function(){topOffset=50,width=this.window.innerWidth>0?this.window.innerWidth:this.screen.width,width<768?($("div.navbar-collapse").addClass("collapse"),topOffset=100):$("div.navbar-collapse").removeClass("collapse"),height=(this.window.innerHeight>0?this.window.innerHeight:this.screen.height)-1,height-=topOffset,height<1&&(height=1),height>topOffset&&$("#page-wrapper").css("min-height",height+"px")});var a=window.location,b=$("ul.nav a").filter(function(){return this.href==a||0==a.href.indexOf(this.href)}).addClass("active").parent().parent().addClass("in").parent();b.is("li")&&b.addClass("active")}function showGenericModal(a,b,c){var d="fa fa-info";switch(a){case"error":d="fa fa-ban"}$("#genericModalHeader").html('<i class="'+d+'"></i> '+b),$("#genericModalBody").html(c),$("#genericModal").modal("show")}function showSessionExpiredModal(){showGenericModal("error","Session expired!","Your session expired. Please login before you do the wanted operation...")}function showLoginModal(){$("#ddLogin").hasClass("disabled")||$("#loginModal").modal("show")}function templateToHtml(a,b){var c=dHTML_TEMPLATE[a];_.each(b,function(b,d){var e="\\$\\{"+d.toUpperCase()+"\\}",f=new RegExp(e,"g"),g=c;c=c.replace(f,b),g==c&&console.log("ATTENTION: template placeholders not used: '"+a+"' "+d.toUpperCase())});var d=c.match(/\$\{.*?\}/g);return d&&d.length>0&&console.log("ATTENTION: template placeholders open: '"+a+"' "+d.toString()),c}function b64EncodeUnicode(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(a,b){return String.fromCharCode("0x"+b)}))}function b64DecodeUnicode(a){return decodeURIComponent(Array.prototype.map.call(atob(a),function(a){return"%"+("00"+a.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function copyLinkToClipboard(){var a="http://www-app.hi.de.bosch.com/CMD_BVT/?branch="+$("#selectBranch").find("option:selected").text().trim()+"&variant="+$("#selectProjectVariant").find("option:selected").text().trim()+"&version=",b="-1";dNAV.version.forEach(function(a){"-1"==b&&a.version_name==$("#selectVersion").find("option:selected").text().trim()&&(b=a.version)}),a+=b,window.prompt("Copy to clipboard: Ctrl+C, Enter",a)}function parseQueryString(){for(var a=window.location.search.substr(1).split("&"),b=0;b<a.length;++b){var c=a[b].split("=",2);2==c.length&&(dQUERY_STRING[c[0]]=decodeURIComponent(c[1].replace(/\+/g," ")))}}function getUserColor(a){var b="rgb(255,0,0)",c=10.625;try{var d=b64EncodeUnicode(a).toLowerCase().replace(/[^a-z]/g,""),e=parseInt((d.charCodeAt(1)-97)*c),f=parseInt((d.charCodeAt(2)-97)*c),g=parseInt((d.charCodeAt(3)-97)*c),h=.2126*e+.7152*f+.0722*g;h>190&&(e=255-e,f=255-f,g=255-g),b="rgb("+e+","+f+","+g+")"}catch(a){}return b}function getTimeToText(a){var b=moment(a,"YYYY-MM-DD HH:mm:ss"),c=moment(),d=moment.duration(c.diff(b)),e=d.asHours(),f="";switch(!0){case e<.25:f="just now";break;case e<1:f="few minutes ago";break;case e<8:f="few hours ago";break;case e<126:f="few days ago";break;case e<336:f="few weeks ago";break;default:f=b.format("DD.MM.YY HH:mm")}return f}function getFromDB(a,b,c){var d=$.Deferred();return $.ajax({type:"GET",url:sDOMAIN+":3000"+a+"?"+b,crossDomain:!0,cache:!0,data:"",dataType:"json",async:!0,xhrFields:{withCredentials:!0}}).done(function(a){c(a,d)}).fail(function(a){console.warn(a),alert("An unexpected error occurred - "+a)}),d}function postToDB(a,b,c){var d=$.Deferred();return $.ajax({type:"POST",url:sDOMAIN+":3000"+a,crossDomain:!0,data:b,dataType:"json",async:!0,xhrFields:{withCredentials:!0}}).done(function(a){c(a,d)}).fail(function(a){console.warn(a),alert("An unexpected error occurred - "+a)}),d}function heartBeat(){setTimeout(function(){getFromDB("/heartbeat","",function(){heartBeat()})},6e4)}function restorePersistedData(){}function installSelectListeners(){$("#selectBranch").on("change",function(){var a=getFromDB("/tml/result/base/selectProjectVariant","branch="+$("#selectBranch").find("option:selected").text(),function(a,b){updateSelect(a,"#selectProjectVariant",b,"branch")});$.when(a).done(function(){getFromDB("/tml/result/base/updateNav","branch="+$("#selectBranch").find("option:selected").text(),function(a){}),delete dQUERY_STRING.variant,delete dQUERY_STRING.version,initSelectVersion()})}),$("#selectProjectVariant").on("change",function(){getFromDB("/tml/result/base/updateNav","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text(),function(a){}),delete dQUERY_STRING.version,initSelectVersion()}),$("#selectVersion").on("change",function(){getFromDB("/tml/result/base/updateNav","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text()+"&version="+$("#selectVersion").find("option:selected").val(),function(a){}),updateDashboard()})}function updateDashboard(){$("#chartAllResultsBars").length&&getFromDB("/tml/result/base/chartBarsAllResults","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text()+"&version="+$("#selectVersion").find("option:selected").val(),function(a){updateChartAllResultsBars(a)}),$("#chartSingleResultDonut").length&&getFromDB("/tml/result/base/chartDoughnutResult","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text()+"&version="+$("#selectVersion").find("option:selected").val(),function(a){updateChartDoughnutResult(a)}),$("#chartFailPerComponentSpider").length&&getFromDB("/tml/result/base/chartRadarFailedUnknownPerComponent","version="+$("#selectVersion").find("option:selected").val(),function(a){updateChartRadarFailPerComponent(a)}),$("#panExeuctionTimeHoursText").length&&getFromDB("/tml/result/base/getExecutionTime","version="+$("#selectVersion").find("option:selected").val(),function(a){updateExecutionTime(a)}),$("#editResultInterpretation").length&&getFromDB("/tml/result/base/getSummerInterpretation","version="+$("#selectVersion").find("option:selected").val(),function(a){updateSummerInterpretation(a)}),$("#btArComponents").length&&getFromDB("/tml/result/base/chartRadarFailedUnknownPerComponent","version="+$("#selectVersion").find("option:selected").val(),function(a){updateBtArComponents(a),getFromDB("/tml/public/getPublicPersistData","component",function(a){void 0!=a.component?$("#btSelectedComponent").text(a.component):$("#btSelectedComponent").text("All Components"),$("#tblTestResult").length&&getFromDB("/tml/result/base/getTestResultDataTable","version="+$("#selectVersion").find("option:selected").val()+"&component="+$("#btSelectedComponent").text(),function(a){updateTestResultDataTable(a)}),$("#btDataTableFilter").length&&getFromDB("/tml/result/base/getDataTableFilterBadgeContent","version="+$("#selectVersion").find("option:selected").val()+"&component="+$("#btSelectedComponent").text(),function(a){updateDataTableFilterBadgeContent(a)})})}),$("#pbTestResult").length&&getFromDB("/tml/result/base/chartDoughnutResult","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text()+"&version="+$("#selectVersion").find("option:selected").val(),function(a){updatePbTestResult(a)})}function setUserBranchProjectVersion(){var a=!1;if(void 0!=dQUERY_STRING.version){var b="-1";dNAV.version.forEach(function(a){"-1"==b&&(a.version_name==dQUERY_STRING.version.trim()?b=a.version:a.version==dQUERY_STRING.version.trim()&&(b=a.version))}),"-1"!=b?($("#selectVersion").val(b),$("#selectVersion").selectpicker("refresh")):(showGenericModal("error","Error","Version not existing: '"+dQUERY_STRING.version.trim()+"'<br><br>Using default values for branch, variant and version instead..."),delete dQUERY_STRING.branch,delete dQUERY_STRING.variant,delete dQUERY_STRING.version,getFromDB("/tml/result/base/updateNav","",function(a){}),a=!0),delete dQUERY_STRING.version}0==a?(updateDashboard(),0==bSELECT_LISTENERS_INSTALLED&&(installSelectListeners(),bSELECT_LISTENERS_INSTALLED=!0)):initSelectBranch()}function initSelectVersion(){var a=!1;if(void 0!=dQUERY_STRING.variant&&(dNAV.variant.indexOf(dQUERY_STRING.variant.trim())>-1?($("#selectProjectVariant").val(dQUERY_STRING.variant.trim()),$("#selectProjectVariant").selectpicker("refresh")):(showGenericModal("error","Error","Variant not existing: '"+dQUERY_STRING.variant.trim()+"'<br><br>Using default values for branch, variant and version instead..."),delete dQUERY_STRING.branch,delete dQUERY_STRING.variant,delete dQUERY_STRING.version,getFromDB("/tml/result/base/updateNav","",function(a){}),a=!0),delete dQUERY_STRING.variant),0==a){var b=getFromDB("/tml/result/base/selectVersion","branch="+$("#selectBranch").find("option:selected").text()+"&project="+$("#selectProjectVariant").find("option:selected").text(),function(a,b){updateSelectExt(a,"#selectVersion",b,["version","version_name"])});$.when(b).done(function(){setUserBranchProjectVersion()})}else initSelectBranch()}function initSelectProjectVariant(){void 0!=dQUERY_STRING.branch&&(dNAV.branch.indexOf(dQUERY_STRING.branch.trim())>-1?($("#selectBranch").val(dQUERY_STRING.branch.trim()),$("#selectBranch").selectpicker("refresh")):(showGenericModal("error","Error","Branch not existing: '"+dQUERY_STRING.branch.trim()+"'<br><br>Using default values for branch, variant and version instead..."),delete dQUERY_STRING.branch,delete dQUERY_STRING.variant,delete dQUERY_STRING.version,getFromDB("/tml/result/base/updateNav","",function(a){})),delete dQUERY_STRING.branch);var a=getFromDB("/tml/result/base/selectProjectVariant","branch="+$("#selectBranch").find("option:selected").text(),function(a,b){updateSelect(a,"#selectProjectVariant",b,"variant")});$.when(a).done(function(){initSelectVersion()})}function initSelectBranch(){var a=getFromDB("/tml/result/base/selectBranch","",function(a,b){updateSelect(a,"#selectBranch",b,"branch")});$.when(a).done(function(){initSelectProjectVariant()})}function initSelectsBranchProjectVariantVersion(){initSelectBranch()}function CreateDatePicker(a,b){function c(a,b){$("#dpTRFReportRange span").html(a.format("DD.MM.YYYY")+" - "+b.format("DD.MM.YYYY"))}if(null===a||null===b)var a=moment().subtract(29,"days"),b=moment();$("#dpTRFReportRange").daterangepicker({startDate:a,endDate:b,ranges:{"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},locale:{format:"DD.MM.YYYY"}},c),c(a,b)}function installDPListener(){$("#dpTRFReportRange").on("apply.daterangepicker",function(a,b){console.log(b.startDate.format("YYYY-MM-DD")),console.log(b.endDate.format("YYYY-MM-DD")),console.log(b),postToDB("/tml/public/setPublicPersistData",{dpTRFReportRange:{startDate:b.startDate.format("DD.MM.YYYY"),endDate:b.endDate.format("DD.MM.YYYY")}},function(a){updateDashboard()})})}function initDatePicker(){getFromDB("/tml/public/getPublicPersistData","dpTRFReportRange",function(a){var b=null,c=null;a.dpTRFReportRange&&(b=moment(a.dpTRFReportRange.startDate,"DD.MM.YYYY"),c=moment(a.dpTRFReportRange.endDate,"DD.MM.YYYY")),CreateDatePicker(b,c),installDPListener()})}function __updateDatePicker__(a){console.log(a),console.log(a.startDate),console.log(a.endDate),$("#dpTRFReportRange").data("daterangepicker").setStartDate(a.startDate),$("#dpTRFReportRange").data("daterangepicker").setEndDate(a.endDate),$("#dpTRFReportRange span").html(a.startDate+" - "+a.endDate),$("#dpTRFReportRange").removeClass("hide")}function updateSelect(a,b,c,d){$(b).html(""),void 0!=d&&(dNAV[d]=a.data),dQUERY_STRING[d]||(dQUERY_STRING[d]=a.selected),a.data.forEach(function(a){$(b).append("<option value="+a+"> "+a+"</option>")}),$(b).selectpicker("refresh"),c&&c.resolve()}function updateSelectExt(a,b,c,d){$(b).html(""),void 0!=d&&(dNAV[d[0]]=[],dNAV[d[1]]=[]),dQUERY_STRING[d[0]]||(dQUERY_STRING[d[0]]=a.selected),a.data.forEach(function(a){if(void 0!=d){var c={};c[d[0]]=a.id,c[d[1]]=a.text,dNAV.version.push(c)}$(b).append("<option value="+a.id+"> "+a.text+"</option>")}),$(b).selectpicker("refresh"),c&&c.resolve()}var addComment=function(a){if(isLoggedIn()){var b="just now",c=0,d=$("#commentField_"+a+" > div:last").attr("id");void 0!=d&&(c=parseInt(d.split("_")[1])+1);var e=templateToHtml("panComment",{TEST_CASE_ID:a,COMMENT_ID:c,COMMENT_TEXT:"",USER_NAME:getDisplayName(),DATETIME:b,USER_NAME:getDisplayName(),USER_BADGE_COLOR:getUserColor(getDisplayName()),USER_BADGE_LETTER:getDisplayName().split(" ")[1].charAt(0).toUpperCase(),STATUS_EDITBUTTONS:""});$("#commentField_"+a).append(e),$("#editComment_"+a+"_"+c).summernote({focus:!0,placeholder:"put your comment here..."})}else showSessionExpiredModal()},installButtonListeners=function(){$("#btArComponents").click(function(a){var b=a.target.firstChild.data;$("#btSelectedComponent").text(b),postToDB("/tml/public/setPublicPersistData",{component:b},function(a){updateDashboard()})}),$(document).on("click",".ddIssueStatus > ul > li > a",function(a){var b=this.id.split("_"),c=b[2];if(this.id=="btIssueStatus_MAILTO_"+c)"select an item"==$("#btIssueStatus_MAILTO_"+c).text().trim()&&a.preventDefault();else switch(a.preventDefault(),$("#"+this.id).text().trim()){case"add comment":addComment(c);break;case"history":alert("history");break;default:var d=$("#"+this.id+" span:first-child").css("background-color"),e=$("#"+this.id+" span:first-child").text();postToDB("/tml/auth/setIssueStatus",{lastlogid:c,issuestatus:e},function(a){"not_authorized"==a.data?showSessionExpiredModal():($("#btIssueStatus_"+c).html('<span class="round round-xs" style="margin-bottom:-3px; background-color:'+d+'"; >'+e+'</span> <span class="caret"></span>'),$("#txtDateTime_"+c).text("just now"),$("#txtUserName_"+c).text($("#badgeUserText").attr("data-original-title")))})}})},editComment_edit=function(a,b){$("#editComment_"+a+"_"+b).summernote({focus:!0,placeholder:"put your comment here..."})},editComment_save=function(a,b){var c=$("#editComment_"+a+"_"+b).summernote("code"),d=b64EncodeUnicode(c);$("#editComment_"+a+"_"+b).summernote("destroy"),postToDB("/tml/auth/postTestCaseComment",{comment:d,testcaseid:a,number:b},function(a){"not_authorized"==a.data&&showSessionExpiredModal()})},deleteComment=function(a,b){var c=bootbox.confirm({title:"Destroy planet?",message:"Do you want to activate the Deathstar now? This cannot be undone.",buttons:{cancel:{label:'<i class="fa fa-times"></i> Cancel'},confirm:{label:'<i class="fa fa-check"></i> Confirm'}},callback:function(a){console.log("This was logged in the callback: "+a)},className:".modal-danger"});c.init(function(){c.find(".modal-header").addClass("modal-danger")})},editResultInterpretation_edit=function(){$("#editResultInterpretation").summernote({focus:!0})},editResultInterpretation_save=function(){var a=$("#editResultInterpretation").summernote("code"),b=b64EncodeUnicode(a);$("#editResultInterpretation").summernote("destroy"),postToDB("/tml/auth/summerInterpretation",{data:b,version:$("#selectVersion").find("option:selected").val()},function(a){"not_authorized"==a.data&&showSessionExpiredModal()})},filterDataTable=function(a,b,c){$("#"+a).hasClass("active")&&(b=""),$("#"+a).toggleClass("active");var d=$("#tblTestResult").dataTable();d.fnFilter(b,c,!0,!0,!0,!0)},filterDataTableClear=function(){var a=$("#tblTestResult").dataTable();a.api().search("").columns().search("").draw(),$("#bt_notPassed").removeClass("active"),$("#bt_noTcid").removeClass("active"),$("#bt_noFid").removeClass("active")},updateBtArComponents=function(a){var b='<li><a href="#">All Components</a></li><li role="separator" class="divider"></li><ARBUTTONS>',c="";_.each(_.sortBy(a.labels),function(a){c+='<li><a href="#">'+a+"</a></li>"}),$("#btArComponents").html(b.replace("<ARBUTTONS>",c))},updateDataTableFilterBadgeContent=function(a){$("#bt_notPassed_badge").text(a.data.not_passed),$("#bt_noTcid_badge").text(a.data.no_tcid),$("#bt_noFid_badge").text(a.data.no_fid)},showLastLog=function(a,b){showGenericModal("info","TML Traceback",'<div id="txtLastLog"><pre><code>loading...</code></pre></div>'),getFromDB("/tml/result/base/getLastLog","lastlogid="+b,function(a){$("#txtLastLog").html('<pre style="color: #CCC; background-color: #202020;"><code>'+hljs.highlight("bash",a.data).value+"</code></pre>")})},dHTML_TEMPLATE={ddIssueStatus:'<div class="ddIssueStatus btn-group" style="margin-left:5px; margin-bottom:-1px;"><button id="btIssueStatus_${TEST_CASE_ID}" type="button" class="btn btn-default btn-xs dropdown-toggle gray" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="round round-xs ${STATUS_COLOR}" style="margin-bottom:-3px;" >${STATUS_TEXT}</span> <span class="caret"></span></button><ul class="dropdown-menu" style="padding-top:0px"><li style="background-color:#F0F0F0;"><a id="btIssueStatus_MAILTO_${TEST_CASE_ID}" href="mailto:${USER_NAME}"><span style="font-size:0.85em; color:#0000FF;"><b><i class="fa fa-clock-o" aria-hidden="true"></i> <span id="txtDateTime_${TEST_CASE_ID}">${DATETIME}</span></b></span></br><span id="txtUserName_${TEST_CASE_ID}"><i id="symEnvelope_${TEST_CASE_ID}" class="fa fa-envelope-o pull-right ${STATUS_ENVELOPE}" style="margin-right:-17px; margin-top:-22px"></i> ${USER_NAME}</span></a></li><li class="divider" style="margin-top:0px"></li><li><a id="btIssueStatus_NE_${TEST_CASE_ID}" href="#"><span class="round round-xs red" style="margin-left:-10px; padding-bottom:6px;">?</span> new issue</a></li><li><a id="btIssueStatus_AN_${TEST_CASE_ID}" href="#"><span class="round round-xs orange" style="margin-left:-10px; padding-bottom:6px;">a</span>  issue in analysis</a></li><li><a id="btIssueStatus_LI_${TEST_CASE_ID}" href="#"><span class="round round-xs blue" style="margin-left:-10px; padding-bottom:6px;">l</span> link with ticket</a></li><li><a id="btIssueStatus_NI_${TEST_CASE_ID}" href="#"><span class="round round-xs green" style="margin-left:-10px; padding-bottom:6px;">n</span> no issue</a></li><li class="divider"></li><li><a id="btIssueStatus_CO_${TEST_CASE_ID}" href="#" class="disabled"><i class="fa fa-comment-o" aria-hidden="true" style="margin-left:-10px;"></i> add comment</a></li><li class="divider"></li><li><a id="btIssueStatus_HI_${TEST_CASE_ID}" href="#"><i class="fa fa-history" aria-hidden="true" style="margin-left:-10px;"></i> history</a></li> </ul></div>',panComment:'<div id="panComment_${COMMENT_ID}" class="panel panel-info" style="margin-bottom:9px;"><div style="height: 25px;padding:2px;"  class="panel-heading"><div class="row"><div class="col-sm-7" style="white-space: nowrap;"><span class="round round-comment" style="background-color:${USER_BADGE_COLOR}; margin-top:-3px;margin-left:-15px;">${USER_BADGE_LETTER}</span><span style="font-size:0.85em; color:#0000FF; margin-top:-1px;"><b> <i class="fa fa-clock-o" aria-hidden="true"></i> <span id="txtCommentDateTime_${TEST_CASE_ID}">${DATETIME}</span></b></span> <span>${USER_NAME}</span></div><div class="col-sm-5" style="float:right;"><div class="pull-right ${STATUS_EDITBUTTONS}" style="background-color: #D9EDF7; border: 2px solid #D9EDF7; border-radius: 4px; display: inline-block; margin-top:-10px; margin-right:-4px;" ><div class="ddCommentFeatures btn-group pull-right"><button id="btCommentFeatures_${TEST_CASE_ID}" type="button" class="btn btn-default btn-sm dropdown-toggle gray" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button><ul class="dropdown-menu" style=""><li><a id="btCommentFeatures_DEL_${TEST_CASE_ID}" href="#" onClick="deleteComment(\'${TEST_CASE_ID}\',${COMMENT_ID});"><i class="fa fa-eraser fa-1x"></i> delete comment</a></li></ul></div><button type="button" class="btn btn-default btn-sm pull-right" onClick="editComment_save(\'${TEST_CASE_ID}\',${COMMENT_ID})"><i class="fa fa-save fa-1x"></i></button><button type="button" class="btn btn-default btn-sm pull-right" onClick="editComment_edit(\'${TEST_CASE_ID}\',${COMMENT_ID})"><i class="fa fa-edit fa-1x"></i></button></div></div></div></div><div id="editComment_${TEST_CASE_ID}_${COMMENT_ID}" class="panel-body" style="padding:5px; ">${COMMENT_TEXT}</div></div>'
};heartBeat(),$(document).ready(function(){parseQueryString(),createMetisMenu(),$('[data-toggle="tooltip"]').tooltip(),$('[data-toggle="popover"]').popover(),$(".pbTooltip").tooltip(),$("#loadGenericModal").load("./dist/html/genericModal.html"),initDatePicker(),initSelectsBranchProjectVariantVersion(),installButtonListeners(),loggedIn(),restorePersistedData()});var dQUERY_STRING={},dPAGE_CHARTS={},dNAV={branch:[],variant:[],version:[]},bSELECT_LISTENERS_INSTALLED=!1,sDOMAIN="http://localhost";